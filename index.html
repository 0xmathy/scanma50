<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scan MA50 v1.2 ‚Äî Screener</title>
<style>
  :root{
    --bg:#0b0d12;--panel:#0f1320;--panel-2:#121727;--text:#e6edf3;--muted:#9aa4b2;
    --green:#29d397;--red:#ff6b6b;--amber:#ffc857;--blue:#6aa7ff;--card:#0c111b;--outline:#1e2a44;
    --side-w:360px;           /* largeur initiale panneau */
    --side-min:280px;         /* largeur mini */
    --side-max:560px;         /* largeur maxi */
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0d16,#0b0d12);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  .wrap{max-width:1250px;margin:24px auto;padding:0 16px}
  header{display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:8px}
  .title{font-weight:700;font-size:22px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .toolbar input,.btn{background:var(--panel-2);color:var(--text);border:1px solid var(--outline);border-radius:10px;padding:8px 10px}
  .btn{cursor:pointer}
  .note{color:var(--muted);font-size:12px;margin:6px 0 14px}

  /* Layout avec colonne tableau flexible + colonne panneau √† largeur variable */
  .layout{
    display:grid;
    grid-template-columns:minmax(0,1fr) var(--side-w);
    gap:16px;
    align-items:start;
  }
  .layout.one-col{ grid-template-columns:1fr; }

  .card{background:var(--panel);border:1px solid var(--outline);border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.35);overflow:hidden}
  .side{position:sticky; top:16px; align-self:start; }

  /* Scroller pour √©viter le crop du tableau */
  .table-scroller{width:100%;overflow:auto}
  table{width:100%;border-collapse:separate;border-spacing:0; min-width:1100px;}
  thead th{position:sticky;top:0;background:linear-gradient(180deg,var(--panel),var(--panel-2));color:#cfe0ff;text-align:left;font-weight:600;font-size:12px;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--outline);padding:10px 10px}
  tbody td{padding:10px 10px;border-bottom:1px solid #0f1422}
  tbody tr:hover{background:rgba(255,255,255,.03)}
  .token{display:flex;align-items:center;gap:10px}
  .logo{width:20px;height:20px;border-radius:6px;background:linear-gradient(135deg,#1e2440,#2c3f6b)}
  .sym{font-weight:700}
  .muted{color:var(--muted)}
  .num{font-variant-numeric:tabular-nums; white-space:nowrap;}
  .t-good{color:var(--green)} .t-warn{color:var(--amber)} .t-bad{color:var(--red)}

  .panel{padding:14px}
  .panel h3{margin:0 0 8px 0;font-size:16px}
  .kv{display:grid;grid-template-columns:auto 1fr;gap:6px;font-size:14px}
  .kv .k{color:var(--muted)}
  .row{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .pin{cursor:pointer;border:1px solid var(--outline);background:var(--panel-2);border-radius:10px;padding:4px 8px;color:var(--muted)}
  .pin.active{color:#fff;border-color:#29d397;box-shadow:inset 0 0 0 1px #29d397}
  .links a{color:#9ec5ff;text-decoration:none;margin-right:8px}

  /* Barre de redimensionnement */
  .resize-col{
    position:relative;
    display:grid;
    grid-template-columns:1fr 6px; /* panneau + poign√©e */
    gap:0;
  }
  .resizer{
    width:6px;
    cursor:col-resize;
    background:transparent;
    position:relative;
  }
  .resizer::after{
    content:"";
    position:absolute; inset:0;
    background:linear-gradient(180deg, transparent 0, transparent 30%, rgba(255,255,255,.06) 30%, rgba(255,255,255,.06) 70%, transparent 70%, transparent 100%);
  }
  .resizer:hover{ background:rgba(255,255,255,.03); }
  .resizing .resizer{ background:rgba(255,255,255,.08); }

  @media (max-width:980px){
    .layout{ grid-template-columns:1fr; }
    .resize-col{ grid-template-columns:1fr; }
    .resizer{ display:none; }
    .side{ position:static; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">Scan MA50 v1.2 ‚Äî Screener</div>
    <div class="toolbar">
      <input id="search" placeholder="Rechercher un token‚Ä¶" />
      <button id="toggleSide" class="btn">üóÇÔ∏è D√©tails</button>
      <button id="btnRefresh" class="btn">‚Üª Rafra√Æchir</button>
      <label><input type="checkbox" id="autoToggle"> Auto-refresh (60s)</label>
    </div>
  </header>
  <div class="note" id="lastupdate">Chargement‚Ä¶</div>

  <div class="layout" id="layout">
    <!-- Tableau -->
    <div class="card">
      <div class="table-scroller">
        <table id="screener">
          <thead>
            <tr>
              <th>Token</th>
              <th style="white-space:nowrap">Date</th>
              <th>Prix</th>
              <th>Œî24h</th>
              <th class="hide-sm">Œî7j</th>
              <th class="hide-sm">Œî30j</th>
              <th>MC</th>
              <th>TVL</th>
              <th>MC/TVL</th>
              <th class="hide-sm">Vol/MC (24h)</th>
              <th class="hide-sm">Moy Vol7j/TVL</th>
              <th>Var Vol 7j/30j</th>
              <th>RSI D</th>
              <th class="hide-sm">ATH</th>
              <th>Potentiel x</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Colonne redimensionnable: panneau + poign√©e -->
    <div class="resize-col" id="resizeCol">
      <div class="card side" id="detailCard">
        <div class="panel">
          <div class="row">
            <h3 id="d-title">D√©tails</h3>
            <button id="pinBtn" class="pin" title="√âpingler / lib√©rer">üìå √âpingler</button>
          </div>

          <div class="kv" id="d-market"></div>
          <hr style="border:0;border-top:1px solid var(--outline);margin:12px 0">
          <div class="kv" id="d-fonda"></div>
          <hr style="border:0;border-top:1px solid var(--outline);margin:12px 0">
          <div class="kv" id="d-social"></div>
          <div class="links" id="d-links" style="margin-top:8px"></div>
        </div>
      </div>
      <div class="resizer" id="resizer" title="Redimensionner"></div>
    </div>
  </div>
</div>

<script>
/* ==== Helpers ==== */
const nf2 = new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 });
const nf1 = new Intl.NumberFormat('en-US', { maximumFractionDigits: 1 });
const money = n => (n==null||isNaN(n)) ? 'N/D' : '$' + (
  Math.abs(n) >= 1e12 ? nf2.format(n/1e12)+'T' :
  Math.abs(n) >= 1e9  ? nf2.format(n/1e9)+'B'  :
  Math.abs(n) >= 1e6  ? nf2.format(n/1e6)+'M'  :
  Math.abs(n) >= 1e3  ? nf2.format(n/1e3)+'K'  :
  nf2.format(n)
);
const fmtPct0 = n => (n==null||isNaN(n)) ? '‚Äî' : `${Math.round(+n)}%`;
const fmtPct  = n => (n==null||isNaN(n)) ? '‚Äî' : `${nf2.format(+n)}%`;
const fmtMult = n => (n==null||isNaN(n)) ? '‚Äî' : `x${nf1.format(+n)}`;
const fmtNum2 = n => (n==null||isNaN(n)) ? '‚Äî' : nf2.format(+n);

/* ==== State ==== */
const tbody = document.querySelector('#screener tbody');
const rows = [];
let tokensData = [];
let pinned = false;
let selectedRow = null;

/* ==== Load data ==== */
async function loadData(){
  try{
    const res = await fetch('data.json', { cache:'no-store' });
    const json = await res.json();
    tokensData = json.tokens||[];
    document.getElementById('lastupdate').textContent = 'Derni√®re M√†J : ' + (json.updated_at||'‚Äî');
    tbody.innerHTML=''; rows.length=0;
    tokensData.forEach(t=> addRow(t));
    applyThresholds();
    if(!selectedRow && rows[0]) { selectRow(rows[0]); }
  }catch(e){
    document.getElementById('lastupdate').textContent = 'Erreur de chargement de data.json';
  }
}

function addRow(t){
  const tr=document.createElement('tr');
  tr.dataset.symbol = t.symbol || '';
  tr.dataset.venue = t.venue || '';
  tr.dataset.price = (t.price!=null ? '$'+nf2.format(+t.price) : '‚Äî');
  tr.dataset.mc = money(t.mc);
  tr.dataset.fdv = t.fdv!=null ? money(t.fdv) : '‚Äî';
  tr.dataset.ath = (t.ath!=null?('$'+nf2.format(+t.ath)):'‚Äî');
  tr.dataset.pot = fmtMult(t.ath_mult);
  tr.dataset.volmc = t.vol_mc_24;
  tr.dataset.vol7tvl = t.vol7_tvl;
  tr.dataset.varv = t.var_vol_7_over_30;
  tr.dataset.rsid = t.rsi_d;
  tr.dataset.tvl = t.tvl;
  tr.dataset.mctvl = t.mc_tvl;
  tr.dataset.alert = t.alert_date || '‚Äî';
  tr.dataset.tvlsrc = t.tvl_source || '';
  tr.dataset.narr = t.narrative || '‚Äî';
  tr.dataset.launch = t.launch_date || '‚Äî';
  tr.dataset.twf = t.twitter_followers || '';
  tr.dataset.site = t.website || '';
  tr.dataset.tw = t.twitter || '';
  tr.dataset.gh = t.github || '';
  tr.dataset.wp = t.whitepaper || '';

  tr.innerHTML = `
    <td><div class="token"><div class="logo"></div><div><span class="sym">${t.symbol||''}</span><span class="muted"> ¬∑ ${t.venue||''}</span></div></div></td>
    <td class="num">${t.alert_date || '‚Äî'}</td>
    <td class="num">${t.price!=null ? '$'+nf2.format(+t.price) : '‚Äî'}</td>
    <td class="num">${fmtPct0(t.d24)}</td>
    <td class="num hide-sm">${fmtPct0(t.d7)}</td>
    <td class="num hide-sm">${fmtPct0(t.d30)}</td>
    <td class="num">${money(t.mc)}</td>
    <td class="num">${t.tvl!=null ? money(t.tvl) : 'N/D'}</td>
    <td class="num">${t.mc_tvl!=null ? fmtNum2(t.mc_tvl) : '‚Äî'}</td>
    <td class="num hide-sm">${fmtPct(t.vol_mc_24)}</td>
    <td class="num hide-sm">${fmtPct(t.vol7_tvl)}</td>
    <td class="num">${t.var_vol_7_over_30!=null ? nf2.format(+t.var_vol_7_over_30)+'√ó' : '‚Äî'}</td>
    <td class="num">${t.rsi_d!=null ? nf2.format(+t.rsi_d) : '‚Äî'}</td>
    <td class="num hide-sm">${t.ath!=null ? '$'+nf2.format(+t.ath) : '‚Äî'}</td>
    <td class="num">${fmtMult(t.ath_mult)}</td>`;

  tr.addEventListener('click', ()=>{ if(!pinned) selectRow(tr); });
  tr.addEventListener('mouseenter', ()=>{ if(!pinned) selectRow(tr); });

  tbody.appendChild(tr);
  rows.push(tr);
}

function selectRow(tr){
  selectedRow = tr;
  rows.forEach(r => r.classList.toggle('selected', r===tr));
  renderDetail(tr);
}

/* Color thresholds */
function applyThresholds(){
  rows.forEach(r=>{
    const mctvl = parseFloat(r.dataset.mctvl);
    const volmc = parseFloat(r.dataset.volmc);
    const rsi   = parseFloat(r.dataset.rsid);

    const cellMcTvl = r.children[8];
    if(cellMcTvl && !isNaN(mctvl)){
      if(mctvl <= 3) cellMcTvl.classList.add('t-good');
      else if(mctvl <= 8) cellMcTvl.classList.add('t-warn');
      else cellMcTvl.classList.add('t-bad');
    }
    const cellVolMc = r.children[9];
    if(cellVolMc && !isNaN(volmc)){
      if(volmc >= 5) cellVolMc.classList.add('t-good');
      else if(volmc >= 2) cellVolMc.classList.add('t-warn');
      else cellVolMc.classList.add('t-bad');
    }
    const rsiCell = r.children[12];
    if(rsiCell && !isNaN(rsi)){
      if(rsi >= 70) rsiCell.classList.add('t-bad');
      else if(rsi >= 45 && rsi <= 60) rsiCell.classList.add('t-good');
      else rsiCell.classList.add('t-warn');
    }
  });
}

/* D√©tail panel */
const dTitle  = document.getElementById('d-title');
const dMarket = document.getElementById('d-market');
const dFonda  = document.getElementById('d-fonda');
const dSocial = document.getElementById('d-social');
const dLinks  = document.getElementById('d-links');
const pinBtn  = document.getElementById('pinBtn');

function renderDetail(r){
  dTitle.textContent = `${r.dataset.symbol} ¬∑ ${r.dataset.venue}`;
  const tvl = r.dataset.tvl ? money(+r.dataset.tvl) : 'N/D';
  const mctvl = r.dataset.mctvl ? fmtNum2(+r.dataset.mctvl) : '‚Äî';

  dMarket.innerHTML = `
    <div class="k">Date</div><div class="num">${r.dataset.alert||'‚Äî'}</div>
    <div class="k">Prix</div><div class="num">${r.dataset.price||'‚Äî'}</div>
    <div class="k">Market Cap</div><div class="num">${r.dataset.mc||'‚Äî'}</div>
    <div class="k">TVL</div><div class="num">${tvl}</div>
    <div class="k">MC/TVL</div><div class="num">${mctvl}</div>
    <div class="k">ATH</div><div class="num">${r.dataset.ath||'‚Äî'}</div>
    <div class="k">Potentiel x</div><div class="num">${r.dataset.pot||'‚Äî'}</div>
    <div class="k">Vol/MC (24h)</div><div class="num">${(isNaN(parseFloat(r.dataset.volmc))?'‚Äî':(nf2.format(parseFloat(r.dataset.volmc))+'%'))}</div>
    <div class="k">Moy Vol7j/TVL</div><div class="num">${(isNaN(parseFloat(r.dataset.vol7tvl))?'‚Äî':(nf2.format(parseFloat(r.dataset.vol7tvl))+'%'))}</div>
    <div class="k">Var Vol 7j/30j</div><div class="num">${r.dataset.varv? nf2.format(+r.dataset.varv)+'√ó':'‚Äî'}</div>
    <div class="k">RSI Daily (14)</div><div class="num">${r.dataset.rsid? nf2.format(+r.dataset.rsid):'‚Äî'}</div>
    <div class="k">Source TVL</div><div class="num">${r.dataset.tvlsrc||'‚Äî'}</div>`;

  dFonda.innerHTML = `
    <div class="k">Narratif</div><div>${r.dataset.narr||'‚Äî'}</div>
    <div class="k">Lancement</div><div class="num">${r.dataset.launch||'‚Äî'}</div>`;

  dSocial.innerHTML = `
    <div class="k">Twitter</div><div class="num">${r.dataset.twf ? nf2.format(+r.dataset.twf) : '‚Äî'}</div>
    <div class="k">FDV</div><div class="num">${r.dataset.fdv||'‚Äî'}</div>`;

  dLinks.innerHTML = [
    r.dataset.site ? `<a href="${r.dataset.site}" target="_blank">Site</a>` : '',
    r.dataset.wp   ? `<a href="${r.dataset.wp}" target="_blank">Whitepaper</a>` : '',
    r.dataset.tw   ? `<a href="${r.dataset.tw}" target="_blank">Twitter</a>` : '',
    r.dataset.gh   ? `<a href="${r.dataset.gh}" target="_blank">GitHub</a>` : ''
  ].filter(Boolean).join(' ');
}

pinBtn.addEventListener('click', ()=>{
  pinned = !pinned;
  pinBtn.classList.toggle('active', pinned);
});

/* Search */
document.getElementById('search').addEventListener('input', (e)=>{
  const q = e.target.value.trim().toLowerCase();
  rows.forEach(r=>{ r.style.display = r.innerText.toLowerCase().includes(q)? '' : 'none'; });
});

/* Refresh */
document.getElementById('btnRefresh').addEventListener('click', loadData);
const autoToggle = document.getElementById('autoToggle');
let autoTimer=null;
function startAuto(){ stopAuto(); autoTimer=setInterval(loadData, 60_000); }
function stopAuto(){ if(autoTimer){ clearInterval(autoTimer); autoTimer=null; } }
autoToggle.checked = localStorage.getItem('autoRefresh')==='1';
if(autoToggle.checked) startAuto();
autoToggle.addEventListener('change', ()=>{ if(autoToggle.checked){ startAuto(); localStorage.setItem('autoRefresh','1'); } else { stopAuto(); localStorage.setItem('autoRefresh','0'); } });

/* Toggle panneau */
const side = document.getElementById('detailCard');
const resizeCol = document.getElementById('resizeCol');
const layout = document.getElementById('layout');
document.getElementById('toggleSide').addEventListener('click', ()=>{
  const hidden = side.classList.toggle('hidden');
  resizeCol.style.display = hidden ? 'none' : 'grid';
  layout.classList.toggle('one-col', hidden);
  localStorage.setItem('sideHidden', hidden ? '1' : '0');
});
if(localStorage.getItem('sideHidden')==='1'){
  side.classList.add('hidden');
  resizeCol.style.display='none';
  layout.classList.add('one-col');
}

/* Redimensionnement (drag) */
const resizer = document.getElementById('resizer');
let isDragging=false, startX=0, startW=0;

function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function setSideWidth(px){
  const min = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--side-min')) || 280;
  const max = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--side-max')) || 560;
  const w = clamp(px, min, Math.min(max, window.innerWidth-240)); // laisse au moins 240px au tableau
  document.documentElement.style.setProperty('--side-w', w+'px');
  localStorage.setItem('sideW', String(w));
}

resizer.addEventListener('mousedown', (e)=>{
  e.preventDefault();
  if(side.classList.contains('hidden')) return;
  isDragging=true;
  document.body.classList.add('resizing');
  startX = e.clientX;
  startW = side.getBoundingClientRect().width;
  window.addEventListener('mousemove', onDrag);
  window.addEventListener('mouseup', onStopDrag);
});
function onDrag(e){
  if(!isDragging) return;
  const dx = e.clientX - startX;
  setSideWidth(startW + dx);
}
function onStopDrag(){
  if(!isDragging) return;
  isDragging=false;
  document.body.classList.remove('resizing');
  window.removeEventListener('mousemove', onDrag);
  window.removeEventListener('mouseup', onStopDrag);
}

/* Restaurer largeur personnalis√©e */
const savedW = parseInt(localStorage.getItem('sideW'),10);
if(!isNaN(savedW)) document.documentElement.style.setProperty('--side-w', savedW+'px');

/* Go */
loadData();
</script>
</body>
</html>
