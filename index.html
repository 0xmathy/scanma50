<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scan MA50 v1.2 â€” Screener</title>
<style>
  :root{
    --bg:#0b1016;--panel:#0f1422;--panel-2:#121a2b;--text:#e9eef5;--muted:#9aa7b8;
    --green:#28d39b;--red:#ff6b6b;--amber:#ffc857;--blue:#8bb7ff;--outline:#1c2742;
    --chip:#0d1a2a; --chip-bd:#223052;
    --radius:14px; --gap:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0f19,#0b1016);color:var(--text);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:6px}
  .title{font-weight:800;font-size:22px;letter-spacing:.2px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .toolbar input,.btn{background:var(--panel-2);color:var(--text);border:1px solid var(--outline);border-radius:12px;padding:8px 12px}
  .btn{cursor:pointer}
  .note{color:var(--muted);font-size:12px;margin:8px 0 16px}
  #debug{display:none;margin:10px 0;padding:10px;border:1px dashed #ff6b6b;color:#ffb3b3;background:#381e1e;border-radius:12px;white-space:pre-wrap}
  #debug.show{display:block}

  .card{background:var(--panel);border:1px solid var(--outline);border-radius:var(--radius);overflow:hidden}
  .table-scroller{width:100%;overflow:auto}
  table{width:100%;border-collapse:separate;border-spacing:0; min-width:1280px;}
  thead th{position:sticky;top:0;background:linear-gradient(180deg,var(--panel),var(--panel-2));
    color:#cfe0ff;text-align:left;font-weight:700;font-size:12px;text-transform:uppercase;
    letter-spacing:.5px;border-bottom:1px solid var(--outline);padding:10px 12px}
  tbody td{padding:10px 12px;border-bottom:1px solid #0e1525; vertical-align:middle;}
  tbody tr:hover{background:rgba(255,255,255,.03)}
  .token{display:flex;align-items:center;gap:10px}
  .logo{width:22px;height:22px;border-radius:7px;background:linear-gradient(135deg,#1f2846,#2a3f6f)}
  .sym{font-weight:800}
  .muted{color:var(--muted)}
  .num{font-variant-numeric:tabular-nums; white-space:nowrap;}
  .t-good{color:var(--green)} .t-warn{color:var(--amber)} .t-bad{color:var(--red)}
  @media (max-width: 1200px){ .col-optional{ display:none; } }

  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{font-size:12px; padding:6px 8px; border-radius:999px;background:var(--chip); border:1px solid var(--chip-bd); color:#dbe6ff;}

  .badges{display:flex;gap:8px;flex-wrap:wrap}
  .badge{font-size:12px; line-height:1; padding:7px 10px; border-radius:10px;
    border:1px solid var(--outline); background:rgba(255,255,255,.03); color:var(--text);
    white-space:nowrap; font-weight:600;}
  .b-good{ border-color: rgba(40,211,155,.45); box-shadow: inset 0 0 0 999px rgba(40,211,155,.09);}
  .b-info{ border-color: rgba(139,183,255,.45); box-shadow: inset 0 0 0 999px rgba(139,183,255,.10);}
  .b-warn{ border-color: rgba(255,200,87,.55); box-shadow: inset 0 0 0 999px rgba(255,200,87,.12);}
  .b-bad{  border-color: rgba(255,107,107,.55); box-shadow: inset 0 0 0 999px rgba(255,107,107,.12);}

  #cardsWrap{ display:block; margin-top:16px; }
  .grid{ display:grid; gap:var(--gap); grid-template-columns: repeat(2, minmax(0,1fr)); }
  @media (min-width:1200px){ .grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
  @media (max-width:800px){ .grid{ grid-template-columns: 1fr; } }
  .sig-card{background:var(--panel); border:1px solid var(--outline); border-radius:16px;
    padding:14px; box-shadow:0 6px 18px rgba(0,0,0,.28); display:flex; flex-direction:column; gap:10px;}
  .sig-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .sig-title{ font-weight:800; font-size:16px; letter-spacing:.2px; }
  .sig-price{ font-weight:700; }
  .sig-sub{ color:var(--muted); font-size:12px; }
  .sig-metrics{ display:flex; gap:8px; flex-wrap:wrap; }
  .sig-divider{ border:0; border-top:1px solid var(--outline); margin:8px 0; opacity:.7 }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">Scan MA50 v1.2 â€” Screener</div>
    <div class="toolbar">
      <input id="search" placeholder="Rechercher un tokenâ€¦" />
      <button id="btnRefresh" class="btn">â†» RafraÃ®chir</button>
      <label><input type="checkbox" id="autoToggle"> Auto-refresh (60s)</label>
    </div>
  </header>
  <div class="note" id="lastupdate">Chargementâ€¦</div>
  <div id="debug"></div>

  <div class="card"><div class="table-scroller">
    <table id="screener">
      <thead><tr>
        <th>Token</th>
        <th>Date</th>
        <th>Prix</th>
        <th>Î”24h</th>
        <th class="col-optional">Î”7j</th>
        <th class="col-optional">Î”30j</th>
        <th>Market Cap</th>
        <th>TVL</th>
        <th>MC/TVL</th>
        <th class="col-optional">Vol/MC (24h)</th>
        <th class="col-optional">Moy Vol 7j</th>
        <th class="col-optional">Moy Vol 30j</th>
        <th class="col-optional">Var Vol 7j/30j</th>
        <th>RSI D</th>
        <th class="col-optional">RSI H4</th>
        <th class="col-optional">ATH (prix)</th>
        <th>x ATH Mcap</th>
      </tr></thead>
      <tbody></tbody>
    </table>
    <div class="note" id="emptyMsg" style="display:none;padding:10px;">Aucune ligne</div>
  </div></div>

  <div id="cardsWrap"><div class="grid" id="cardsGrid"></div></div>
</div>

<script>
const debugBox = document.getElementById('debug');
function debug(msg){ try{ debugBox.classList.add('show'); debugBox.textContent += (debugBox.textContent? '\\n':'') + msg; console.error(msg);}catch(_){} }
window.addEventListener('error', e=> debug('JS Error: '+(e.error?.message||e.message)));
window.addEventListener('unhandledrejection', e=> debug('Promise Rejection: '+(e.reason?.message||e.reason)));

const nf1 = new Intl.NumberFormat('en-US',{ maximumFractionDigits: 1 });
const nf2 = new Intl.NumberFormat('en-US',{ maximumFractionDigits: 2 });
const money = n => (n==null||isNaN(n)) ? 'N/D' : '$' + (
  Math.abs(n)>=1e12? nf2.format(n/1e12)+'T' :
  Math.abs(n)>=1e9 ? nf2.format(n/1e9)+'B' :
  Math.abs(n)>=1e6 ? nf2.format(n/1e6)+'M' :
  Math.abs(n)>=1e3 ? nf2.format(n/1e3)+'K' : nf2.format(n)
);
const fmtPct0 = n => (n==null||isNaN(n)) ? 'â€”' : `${Math.round(+n)}%`;
const fmtPct  = n => (n==null||isNaN(n)) ? 'â€”' : `${nf2.format(+n)}%`;
const fmtNum2 = n => (n==null||isNaN(n)) ? 'â€”' : nf2.format(+n);

const tbody = document.querySelector('#screener tbody');
const emptyMsg = document.getElementById('emptyMsg');
const lastupdate = document.getElementById('lastupdate');
const searchInput = document.getElementById('search');
const btnRefresh = document.getElementById('btnRefresh');
const autoToggle = document.getElementById('autoToggle');
const cardsGrid = document.getElementById('cardsGrid');

let allRows = [];
let autoTimer=null;

function buildSignals(t){
  const s=[];
  if(t.tvl == null) s.push({k:'TVL N/D', c:'b-bad', pri:1});
  if(t.mc_tvl != null && t.mc_tvl <= 3) s.push({k:'ðŸ’Ž MC/TVLâ‰¤3', c:'b-good', pri:3});
  if(t.mc_tvl != null && t.mc_tvl > 12) s.push({k:'MC/TVL>12', c:'b-bad', pri:2});
  if(t.var_vol_7_over_30 != null && t.var_vol_7_over_30 >= 1.5) s.push({k:'âš¡ Vol7/30â‰¥1.5', c:'b-info', pri:4});
  if(t.vol_mc_24 != null && t.vol_mc_24 >= 5) s.push({k:'ðŸ’§ Vol/MCâ‰¥5%', c:'b-good', pri:5});
  if(t.vol_mc_24 != null && t.vol_mc_24 < 1) s.push({k:'Illiquid', c:'b-warn', pri:5});
  if(t.x_ath_mc != null && t.x_ath_mc >= 3) s.push({k:'ðŸŽ¯ xâ‰¥3 ATH Mcap', c:'b-info', pri:6});
  if(t.x_ath_mc != null && t.x_ath_mc < 1) s.push({k:'Near ATH Mcap', c:'b-warn', pri:7});
  if(t.rsi_d != null && t.rsi_d <= 35) s.push({k:'ðŸ§Š RSI Dâ‰¤35', c:'b-info', pri:8});
  if(t.rsi_d != null && t.rsi_d >= 70) s.push({k:'ðŸŸ¥ RSI Dâ‰¥70', c:'b-bad', pri:8});
  return s.sort((a,b)=>a.pri-b.pri);
}

function render(json){
  const data = Array.isArray(json?.tokens) ? json.tokens : [];
  lastupdate.textContent = 'DerniÃ¨re MÃ J : ' + (json.updated_at || 'â€”');

  tbody.innerHTML=''; allRows.length=0;
  if(!data.length){ emptyMsg.style.display='block'; cardsGrid.innerHTML=''; return; }
  emptyMsg.style.display='none';

  data.forEach(t=>{
    const tr = document.createElement('tr');

    const price = (t.price!=null) ? '$'+nf2.format(+t.price) : 'â€”';
    const d24 = fmtPct0(t.d24);
    const d7  = fmtPct0(t.d7);
    const d30 = fmtPct0(t.d30);
    const mc  = money(t.mc);
    const tvl = (t.tvl!=null) ? money(t.tvl) : 'N/D';
    const mctvl = (t.mc!=null && t.tvl!=null && t.tvl>0) ? nf2.format(t.mc/t.tvl) : 'â€”';
    const volmc = (t.vol_mc_24!=null) ? nf2.format(+t.vol_mc_24)+'%' : 'â€”';
    const vol7  = (t.vol7_avg!=null) ? money(t.vol7_avg) : 'â€”';
    const vol30 = (t.vol30_avg!=null) ? money(t.vol30_avg) : 'â€”';
    const var73 = (t.var_vol_7_over_30!=null) ? nf2.format(+t.var_vol_7_over_30)+'Ã—' : 'â€”';
    const rsid = (t.rsi_d!=null) ? nf2.format(+t.rsi_d) : 'â€”';
    const rsih4= (t.rsi_h4!=null) ? nf2.format(+t.rsi_h4) : 'â€”';
    const ath  = (t.ath!=null) ? '$'+nf2.format(+t.ath) : 'â€”';
    const xath = (t.x_ath_mc!=null) ? 'x'+nf1.format(+t.x_ath_mc) : 'â€”';

    tr.innerHTML = `
      <td><div class="token"><div class="logo"></div><div><span class="sym">${t.symbol||''}</span><span class="muted"> Â· ${t.venue||''}</span></div></div></td>
      <td class="num">${t.alert_date || 'â€”'}</td>
      <td class="num">${price}</td>
      <td class="num">${d24}</td>
      <td class="num col-optional">${d7}</td>
      <td class="num col-optional">${d30}</td>
      <td class="num">${mc}</td>
      <td class="num">${tvl}</td>
      <td class="num">${mctvl}</td>
      <td class="num col-optional">${volmc}</td>
      <td class="num col-optional">${vol7}</td>
      <td class="num col-optional">${vol30}</td>
      <td class="num col-optional">${var73}</td>
      <td class="num">${rsid}</td>
      <td class="num col-optional">${rsih4}</td>
      <td class="num col-optional">${ath}</td>
      <td class="num">${xath}</td>
    `;

    // couleurs
    const mctvlCell = tr.children[8];
    const mctvlVal = (t.mc!=null && t.tvl!=null && t.tvl>0) ? (t.mc/t.tvl) : NaN;
    if(!isNaN(mctvlVal)){
      if(mctvlVal <= 3) mctvlCell.classList.add('t-good');
      else if(mctvlVal <= 8) mctvlCell.classList.add('t-warn');
      else mctvlCell.classList.add('t-bad');
    }
    const volCell = tr.children[9];
    const volVal = parseFloat(t.vol_mc_24);
    if(!isNaN(volVal)){
      if(volVal >= 5) volCell.classList.add('t-good');
      else if(volVal >= 2) volCell.classList.add('t-warn');
      else volCell.classList.add('t-bad');
    }
    const rsiDCell = tr.children[13];
    const rsiDVal = parseFloat(t.rsi_d);
    if(!isNaN(rsiDVal)){
      if(rsiDVal >= 70) rsiDCell.classList.add('t-bad');
      else if(rsiDVal >= 45 && rsiDVal <= 60) rsiDCell.classList.add('t-good');
      else rsiDCell.classList.add('t-warn');
    }

    tbody.appendChild(tr);
    allRows.push(tr);
  });

  // cartes
  cardsGrid.innerHTML='';
  data.forEach(t=>{
    const sigs = buildSignals(t);
    const div = document.createElement('div');
    div.className='sig-card';
    div.innerHTML=`
      <div class="sig-head">
        <div>
          <div class="sig-title">${t.symbol||''}</div>
          <div class="sig-sub">${t.alert_date||'â€”'} Â· ${t.venue||''}</div>
        </div>
        <div class="sig-price">${t.price!=null ? '$'+nf2.format(+t.price) : 'â€”'}</div>
      </div>
      <div class="sig-sub">MC ${money(t.mc)} Â· TVL ${t.tvl!=null?money(t.tvl):'N/D'}</div>
      <div class="sig-metrics">
        <span class="chip">MC/TVL ${t.mc_tvl!=null?fmtNum2(t.mc_tvl):'â€”'}</span>
        <span class="chip">RSI D ${t.rsi_d!=null?nf2.format(+t.rsi_d):'â€”'}</span>
        <span class="chip">x ATH Mcap ${t.x_ath_mc!=null?('x'+nf1.format(+t.x_ath_mc)):'â€”'}</span>
        <span class="chip">Vol/MC 24h ${t.vol_mc_24!=null?fmtPct(t.vol_mc_24):'â€”'}</span>
        <span class="chip">Vol7/30 ${t.var_vol_7_over_30!=null?nf2.format(+t.var_vol_7_over_30)+'Ã—':'â€”'}</span>
      </div>
      ${ (sigs.length? '<div class="badges">'+sigs.map(x=>`<span class="badge ${x.c}">${x.k}</span>`).join('')+'</div>' : '') }
    `;
    cardsGrid.appendChild(div);
  });
}

async function loadData(){
  try{
    const res = await fetch('data.json?ts='+Date.now(), { cache:'no-store' });
    if(!res.ok){ debug(`HTTP ${res.status} ${res.statusText} sur data.json`); render({ tokens: [] }); lastupdate.textContent = 'Erreur: data.json introuvable'; return; }
    const json = await res.json();
    if(!json || !Array.isArray(json.tokens)){ debug('Format data.json inattendu'); render({ tokens: [] }); lastupdate.textContent='Erreur: format data.json'; return; }
    render(json);
  }catch(e){
    debug('loadData() failed: '+(e.message||e));
    render({ tokens: [] });
    lastupdate.textContent = 'Erreur de chargement';
  }
}

document.getElementById('search').addEventListener('input', (e)=>{
  const q = e.target.value.trim().toLowerCase();
  document.querySelectorAll('#screener tbody tr').forEach(r=>{
    r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none';
  });
});
document.getElementById('btnRefresh').addEventListener('click', loadData);

let autoTimer=null;
function startAuto(){ stopAuto(); autoTimer=setInterval(loadData, 60_000); }
function stopAuto(){ if(autoTimer){ clearInterval(autoTimer); autoTimer=null; } }
autoToggle.checked = localStorage.getItem('autoRefresh')==='1';
if(autoToggle.checked) startAuto();
autoToggle.addEventListener('change', ()=>{
  if(autoToggle.checked){ startAuto(); localStorage.setItem('autoRefresh','1'); }
  else { stopAuto(); localStorage.setItem('autoRefresh','0'); }
});

document.addEventListener('DOMContentLoaded', loadData);
</script>
</body>
</html>
