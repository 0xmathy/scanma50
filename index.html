<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scan MA50 v1.2 ‚Äî Screener</title>
<style>
  :root{
    --bg:#0b1016;--panel:#0f1422;--panel-2:#121a2b;--text:#e9eef5;--muted:#9aa7b8;
    --green:#28d39b;--red:#ff6b6b;--amber:#ffc857;--blue:#8bb7ff;--outline:#1c2742;
    --chip:#0d1a2a; --chip-bd:#223052;
    --radius:14px; --gap:14px;
    --drawer-w:420px; --drawer-min:300px; --drawer-max:640px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0f19,#0b1016);color:var(--text);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:6px}
  .title{font-weight:800;font-size:22px;letter-spacing:.2px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .toolbar input,.btn{background:var(--panel-2);color:var(--text);border:1px solid var(--outline);border-radius:12px;padding:8px 12px}
  .btn{cursor:pointer}
  .note{color:var(--muted);font-size:12px;margin:8px 0 16px}

  /* Debug */
  #debug{display:none;margin:10px 0;padding:10px;border:1px dashed #ff6b6b;color:#ffb3b3;background:#381e1e;border-radius:12px;white-space:pre-wrap}
  #debug.show{display:block}

  /* --- Table compacte (m√©triques brutes) --- */
  .card{background:var(--panel);border:1px solid var(--outline);border-radius:var(--radius);box-shadow:0 10px 26px rgba(0,0,0,.35);overflow:hidden}
  .table-scroller{width:100%;overflow:auto}
  table{width:100%;border-collapse:separate;border-spacing:0; min-width:960px;}
  thead th{
    position:sticky;top:0;background:linear-gradient(180deg,var(--panel),var(--panel-2));
    color:#cfe0ff;text-align:left;font-weight:700;font-size:12px;text-transform:uppercase;
    letter-spacing:.5px;border-bottom:1px solid var(--outline);padding:10px 12px
  }
  tbody td{padding:10px 12px;border-bottom:1px solid #0e1525; vertical-align:middle;}
  tbody tr:hover{background:rgba(255,255,255,.03)}
  .token{display:flex;align-items:center;gap:10px}
  .logo{width:22px;height:22px;border-radius:7px;background:linear-gradient(135deg,#1f2846,#2a3f6f)}
  .sym{font-weight:800}
  .muted{color:var(--muted)}
  .num{font-variant-numeric:tabular-nums; white-space:nowrap;}
  .t-good{color:var(--green)} .t-warn{color:var(--amber)} .t-bad{color:var(--red)}
  @media (max-width: 1200px){ .col-optional{ display:none; } }

  /* --- Chips m√©triques --- */
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{
    font-size:12px; padding:6px 8px; border-radius:999px;
    background:var(--chip); border:1px solid var(--chip-bd); color:#dbe6ff;
  }

  /* --- Badges (signaux) --- */
  .badges{display:flex;gap:8px;flex-wrap:wrap}
  .badge{
    font-size:12px; line-height:1; padding:7px 10px; border-radius:10px;
    border:1px solid var(--outline); background:rgba(255,255,255,.03); color:var(--text);
    white-space:nowrap; font-weight:600;
  }
  .b-good{ border-color: rgba(40,211,155,.45); box-shadow: inset 0 0 0 999px rgba(40,211,155,.09);}
  .b-info{ border-color: rgba(139,183,255,.45); box-shadow: inset 0 0 0 999px rgba(139,183,255,.10);}
  .b-warn{ border-color: rgba(255,200,87,.55); box-shadow: inset 0 0 0 999px rgba(255,200,87,.12);}
  .b-bad{  border-color: rgba(255,107,107,.55); box-shadow: inset 0 0 0 999px rgba(255,107,107,.12);}

  /* --- Cartes d√©taill√©es et a√©r√©es --- */
  #cardsWrap{ display:none; margin-top:16px; }
  #cardsWrap.show{ display:block; }
  .grid{ display:grid; gap:var(--gap); grid-template-columns: repeat(2, minmax(0,1fr)); }
  @media (min-width:1200px){ .grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
  @media (max-width:800px){ .grid{ grid-template-columns: 1fr; } }

  .sig-card{
    background:var(--panel); border:1px solid var(--outline); border-radius:16px;
    padding:14px; box-shadow:0 6px 18px rgba(0,0,0,.28);
    display:flex; flex-direction:column; gap:10px;
  }
  .sig-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .sig-title{ font-weight:800; font-size:16px; letter-spacing:.2px; }
  .sig-price{ font-weight:700; }
  .sig-sub{ color:var(--muted); font-size:12px; }
  .sig-metrics{ display:flex; gap:8px; flex-wrap:wrap; }
  .sig-section{ display:flex; flex-direction:column; gap:8px; }
  .sig-divider{ border:0; border-top:1px solid var(--outline); margin:8px 0; opacity:.7 }

  .sig-actions{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .linkbar a{ color:#9ec5ff; text-decoration:none; margin-right:10px; font-size:12px; }
  .btn-ghost{ background:transparent; border:1px solid var(--outline); color:#cfe0ff; border-radius:10px; padding:6px 10px; cursor:pointer; font-size:12px; }

  /* Drawer */
  #drawer{
    position:fixed; top:0; right:0; height:100vh;
    width:var(--drawer-w);
    background:var(--panel); border-left:1px solid var(--outline);
    box-shadow:-20px 0 40px rgba(0,0,0,.45);
    transform:translateX(100%); transition:transform .2s ease;
    z-index:1000; display:flex; flex-direction:column;
  }
  #drawer.open{ transform:none; }
  #drawer .head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--outline)}
  #drawer .head h3{margin:0;font-size:16px}
  #drawer .btns{display:flex;gap:8px}
  #drawer .content{padding:12px 14px; overflow:auto; flex:1}
  .kv{display:grid;grid-template-columns:auto 1fr;gap:6px;font-size:14px}
  .kv .k{color:var(--muted)}
  .links a{color:#9ec5ff;text-decoration:none;margin-right:8px}
  #drawer .resizer{position:absolute; left:-6px; top:0; width:6px; height:100%; cursor:col-resize; background:transparent;}
  #drawer .resizer:hover{ background:rgba(255,255,255,.06); }
  #backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.25); opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:900; }
  #backdrop.show{ opacity:1; pointer-events:auto; }

  @media (max-width:980px){
    #drawer{ width:100%; height:70vh; left:0; right:auto; bottom:0; top:auto; border-left:0; border-top:1px solid var(--outline); transform:translateY(100%); }
    #drawer.open{ transform:translateY(0); }
    #drawer .resizer{ display:none; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">Scan MA50 v1.2 ‚Äî Screener</div>
    <div class="toolbar">
      <input id="search" placeholder="Rechercher un token‚Ä¶" />
      <button id="openDetails" class="btn">üóÇÔ∏è D√©tails</button>
      <button id="btnRefresh" class="btn">‚Üª Rafra√Æchir</button>
      <label><input type="checkbox" id="autoToggle"> Auto-refresh (60s)</label>
      <label><input type="checkbox" id="cardsToggle" checked> Afficher cartes de signaux</label>
    </div>
  </header>
  <div class="note" id="lastupdate">Chargement‚Ä¶</div>
  <div id="debug"></div>

  <!-- Tableau compact -->
  <div class="card">
    <div class="table-scroller">
      <table id="screener">
        <thead>
          <tr>
            <th>Token</th>
            <th style="white-space:nowrap">Date</th>
            <th>Prix</th>
            <th>Œî24h</th>
            <th class="col-optional">Œî7j</th>
            <th class="col-optional">Œî30j</th>
            <th>MC</th>
            <th>TVL</th>
            <th>MC/TVL</th>
            <th class="col-optional">Vol/MC (24h)</th>
            <th class="col-optional">Moy Vol7j/TVL</th>
            <th class="col-optional">Var Vol 7j/30j</th>
            <th>RSI D</th>
            <th class="col-optional">RSI H4</th>
            <th class="col-optional">ATH</th>
            <th>x ATH Mcap</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="note" id="emptyMsg" style="display:none;padding:10px;">Aucune ligne √† afficher (data.json vide ?)</div>
    </div>
  </div>

  <!-- Cartes d√©taill√©es, a√©r√©es -->
  <div id="cardsWrap">
    <div class="grid" id="cardsGrid"></div>
  </div>
</div>

<!-- Drawer -->
<div id="backdrop"></div>
<aside id="drawer" aria-hidden="true">
  <div class="resizer" id="drawerResizer" title="Redimensionner"></div>
  <div class="head">
    <h3 id="d-title">D√©tails</h3>
    <div class="btns">
      <button id="pinBtn" class="btn" title="√âpingler / lib√©rer">üìå √âpingler</button>
      <button id="closeDrawer" class="btn" title="Fermer">‚úñ</button>
    </div>
  </div>
  <div class="content">
    <h4>üìä March√©</h4>
    <div class="kv" id="d-market"></div>
    <div style="margin:10px 0;"><div id="d-signals" class="badges"></div></div>
    <hr style="border:0;border-top:1px solid var(--outline);margin:12px 0">
    <h4>üß© Fonda</h4>
    <div class="kv" id="d-fonda"></div>
    <hr style="border:0;border-top:1px solid var(--outline);margin:12px 0">
    <h4>üì£ Social & Liens</h4>
    <div class="kv" id="d-social"></div>
    <div class="links" id="d-links" style="margin-top:8px"></div>
  </div>
</aside>

<script>
/* Debug */
const debugBox = document.getElementById('debug');
function debug(msg){ debugBox.classList.add('show'); debugBox.textContent += (debugBox.textContent ? '\n' : '') + msg; console.error(msg); }
window.addEventListener('error', (e)=> debug('JS Error: '+ (e.error?.message || e.message)));
window.addEventListener('unhandledrejection', (e)=> debug('Promise Rejection: '+ (e.reason?.message || e.reason)));

/* Formatters */
const nf2 = new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 });
const nf1 = new Intl.NumberFormat('en-US', { maximumFractionDigits: 1 });
const money = n => (n==null||isNaN(n)) ? 'N/D' : '$' + (
  Math.abs(n) >= 1e12 ? nf2.format(n/1e12)+'T' :
  Math.abs(n) >= 1e9  ? nf2.format(n/1e9)+'B'  :
  Math.abs(n) >= 1e6  ? nf2.format(n/1e6)+'M'  :
  Math.abs(n) >= 1e3  ? nf2.format(n/1e3)+'K'  :
  nf2.format(n)
);
const fmtPct0 = n => (n==null||isNaN(n)) ? '‚Äî' : `${Math.round(+n)}%`;
const fmtPct  = n => (n==null||isNaN(n)) ? '‚Äî' : `${nf2.format(+n)}%`;
const fmtNum2 = n => (n==null||isNaN(n)) ? '‚Äî' : nf2.format(+n);

/* State */
const tbody = document.querySelector('#screener tbody');
const emptyMsg = document.getElementById('emptyMsg');
const rows = [];
let tokensData = [];
let pinned = false;
let drawerOpen = false;

/* Signals */
function buildSignals(t){
  const s = [];
  if(t.tvl == null) s.push({k:'TVL N/D', c:'b-bad', pri:1, key:'tvl_nd'});
  if(t.mc_tvl != null && t.mc_tvl <= 3) s.push({k:'üíé MC/TVL‚â§3', c:'b-good', pri:3, key:'mctvl_low'});
  if(t.mc_tvl != null && t.mc_tvl > 12) s.push({k:'MC/TVL>12', c:'b-bad', pri:2, key:'mctvl_high'});
  if(t.var_vol_7_over_30 != null && t.var_vol_7_over_30 >= 1.5) s.push({k:'‚ö° Vol7/30‚â•1.5', c:'b-info', pri:4, key:'mom_vol'});
  if(t.vol_mc_24 != null && t.vol_mc_24 >= 5) s.push({k:'üíß Vol/MC‚â•5%', c:'b-good', pri:5, key:'liq_good'});
  if(t.vol_mc_24 != null && t.vol_mc_24 < 1) s.push({k:'Illiquid', c:'b-warn', pri:5, key:'liq_low'});
  if(t.x_ath_mc != null && t.x_ath_mc >= 3) s.push({k:'üéØ x‚â•3 ATH Mcap', c:'b-info', pri:6, key:'upside'});
  if(t.x_ath_mc != null && t.x_ath_mc < 1) s.push({k:'Near ATH Mcap', c:'b-warn', pri:7, key:'near_ath'});
  if(t.rsi_d != null && t.rsi_d <= 35) s.push({k:'üßä RSI D‚â§35', c:'b-info', pri:8, key:'rsi_oversold'});
  if(t.rsi_d != null && t.rsi_d >= 70) s.push({k:'üü• RSI D‚â•70', c:'b-bad', pri:8, key:'rsi_overbought'});
  return s.sort((a,b)=>a.pri-b.pri);
}
const SIGNAL_EXPLAIN = {
  tvl_nd: "Pas de TVL fiable trouv√©e (match auto DeFiLlama) ‚Üí ratios TVL incomplets.",
  mctvl_low: "Capitalisation proche de l‚Äôactivit√© on-chain (moins de prime sp√©culative).",
  mctvl_high:"Capitalisation tendue vs TVL ‚Üí prudence (sur√©valuation potentielle).",
  mom_vol: "Momentum: le volume moyen 7j d√©passe nettement le 30j.",
  liq_good:"Liquidit√© saine : volume/MC sur 24h ‚â• 5% (slippage r√©duit).",
  liq_low: "Faible liquidit√© : volume/MC sur 24h < 1% (slippage/m√®ches possibles).",
  upside:  "Potentiel si retour √† l‚ÄôATH de market cap (neutralise la dilution).",
  near_ath:"Proche des sommets historiques de market cap (peu d‚Äôupside).",
  rsi_oversold:"RSI Daily en zone de survente potentielle.",
  rsi_overbought:"RSI Daily en zone de surachat potentielle."
};
const badgesHTML = (list)=> `<div class="badges">` + list.map(x=>`<span class="badge ${x.c}" title="${x.k}">${x.k}</span>`).join('') + `</div>`;

/* Data load */
async function loadData(){
  try{
    const res = await fetch('data.json', { cache:'no-store' });
    if(!res.ok){ debug('HTTP data.json: '+res.status+' '+res.statusText); }
    const json = await res.json().catch(e=>{ throw new Error('JSON parse error: '+e.message); });
    tokensData = json.tokens||[];
    document.getElementById('lastupdate').textContent = 'Derni√®re M√†J : ' + (json.updated_at||'‚Äî');
    renderTable(tokensData);
    renderCards(tokensData);
  }catch(e){
    debug('loadData() failed: '+ (e.message||e));
    document.getElementById('lastupdate').textContent = 'Erreur de chargement de data.json';
  }
}

/* Table */
function renderTable(list){
  tbody.innerHTML=''; rows.length=0;
  if(!list.length){ emptyMsg.style.display='block'; return; }
  emptyMsg.style.display='none';
  list.forEach(t=> addRow(t));
  applyThresholds();
}
function addRow(t){
  const tr=document.createElement('tr');
  tr.dataset.symbol = t.symbol || '';
  tr.dataset.venue = t.venue || '';
  tr.dataset.price = (t.price!=null ? '$'+nf2.format(+t.price) : '‚Äî');
  tr.dataset.mc = money(t.mc);
  tr.dataset.fdv = t.fdv!=null ? money(t.fdv) : '‚Äî';
  tr.dataset.ath = (t.ath!=null?('$'+nf2.format(+t.ath)):'‚Äî');
  tr.dataset.athmc = t.ath_mc!=null ? money(t.ath_mc) : '‚Äî';
  tr.dataset.xathmc = t.x_ath_mc;
  tr.dataset.pricetarget = (t.price_target_ath_mc!=null ? '$'+nf2.format(+t.price_target_ath_mc) : '‚Äî');
  tr.dataset.volmc = t.vol_mc_24;
  tr.dataset.vol7tvl = t.vol7_tvl;
  tr.dataset.varv = t.var_vol_7_over_30;
  tr.dataset.rsid = t.rsi_d;
  tr.dataset.rsih4 = t.rsi_h4;
  tr.dataset.tvl = t.tvl;
  tr.dataset.mctvl = t.mc_tvl;
  tr.dataset.alert = t.alert_date || '‚Äî';
  tr.dataset.tvlsrc = t.tvl_source || '';
  tr.dataset.narr = t.narrative || '‚Äî';
  tr.dataset.launch = t.launch_date || '‚Äî';
  tr.dataset.twf = t.twitter_followers || '';
  tr.dataset.site = t.website || '';
  tr.dataset.tw = t.twitter || '';
  tr.dataset.gh = t.github || '';
  tr.dataset.wp = t.whitepaper || '';

  tr.innerHTML = `
    <td><div class="token"><div class="logo"></div><div><span class="sym">${t.symbol||''}</span><span class="muted"> ¬∑ ${t.venue||''}</span></div></div></td>
    <td class="num">${t.alert_date || '‚Äî'}</td>
    <td class="num">${t.price!=null ? '$'+nf2.format(+t.price) : '‚Äî'}</td>
    <td class="num">${fmtPct0(t.d24)}</td>
    <td class="num col-optional">${fmtPct0(t.d7)}</td>
    <td class="num col-optional">${fmtPct0(t.d30)}</td>
    <td class="num">${money(t.mc)}</td>
    <td class="num">${t.tvl!=null ? money(t.tvl) : 'N/D'}</td>
    <td class="num">${t.mc_tvl!=null ? fmtNum2(t.mc_tvl) : '‚Äî'}</td>
    <td class="num col-optional">${fmtPct(t.vol_mc_24)}</td>
    <td class="num col-optional">${fmtPct(t.vol7_tvl)}</td>
    <td class="num col-optional">${t.var_vol_7_over_30!=null ? nf2.format(+t.var_vol_7_over_30)+'√ó' : '‚Äî'}</td>
    <td class="num">${t.rsi_d!=null ? nf2.format(+t.rsi_d) : '‚Äî'}</td>
    <td class="num col-optional">${t.rsi_h4!=null ? nf2.format(+t.rsi_h4) : '‚Äî'}</td>
    <td class="num col-optional">${t.ath!=null ? '$'+nf2.format(+t.ath) : '‚Äî'}</td>
    <td class="num">${t.x_ath_mc!=null ? 'x'+nf1.format(+t.x_ath_mc) : '‚Äî'}</td>`;

  tr.addEventListener('click', ()=>{ selectRow(tr, true); });
  tr.addEventListener('mouseenter', ()=>{ if(!pinned) selectRow(tr, false); });

  tbody.appendChild(tr);
  rows.push(tr);
}
function applyThresholds(){
  rows.forEach(r=>{
    const mctvl = parseFloat(r.dataset.mctvl);
    const volmc = parseFloat(r.dataset.volmc);
    const rsiD  = parseFloat(r.dataset.rsid);
    const rsiH4 = parseFloat(r.dataset.rsih4);

    const mcTvlCell = r.children[8];
    if(mcTvlCell && !isNaN(mctvl)){
      if(mctvl <= 3) mcTvlCell.classList.add('t-good');
      else if(mctvl <= 8) mcTvlCell.classList.add('t-warn');
      else mcTvlCell.classList.add('t-bad');
    }
    const volCell = r.children[9];
    if(volCell && !isNaN(volmc)){
      if(volmc >= 5) volCell.classList.add('t-good');
      else if(volmc >= 2) volCell.classList.add('t-warn');
      else volCell.classList.add('t-bad');
    }
    const rsiDCell = r.children[12];
    if(rsiDCell && !isNaN(rsiD)){
      if(rsiD >= 70) rsiDCell.classList.add('t-bad');
      else if(rsiD >= 45 && rsiD <= 60) rsiDCell.classList.add('t-good');
      else rsiDCell.classList.add('t-warn');
    }
    const rsiH4Cell = r.children[13];
    if(rsiH4Cell && !isNaN(rsiH4)){
      if(rsiH4 >= 70) rsiH4Cell.classList.add('t-bad');
      else if(rsiH4 >= 45 && rsiH4 <= 60) rsiH4Cell.classList.add('t-good');
      else rsiH4Cell.classList.add('t-warn');
    }
  });
}

/* Drawer */
const drawer = document.getElementById('drawer');
const backdrop = document.getElementById('backdrop');
const dTitle  = document.getElementById('d-title');
const dMarket = document.getElementById('d-market');
const dFonda  = document.getElementById('d-fonda');
const dSocial = document.getElementById('d-social');
const dLinks  = document.getElementById('d-links');
const dSignals= document.getElementById('d-signals');
const openBtn = document.getElementById('openDetails');
const closeBtn = document.getElementById('closeDrawer');
const pinBtn = document.getElementById('pinBtn');

function openDrawer(){ if(!drawerOpen){ drawer.classList.add('open'); backdrop.classList.add('show'); drawerOpen = true; } }
function closeDrawer(){ if(drawerOpen){ drawer.classList.remove('open'); backdrop.classList.remove('show'); drawerOpen = false; } }
openBtn.addEventListener('click', ()=>{ drawerOpen ? closeDrawer() : openDrawer(); });
closeBtn.addEventListener('click', closeDrawer);
backdrop.addEventListener('click', ()=>{ if(!pinned) closeDrawer(); });
pinBtn.addEventListener('click', ()=>{ pinned = !pinned; pinBtn.textContent = pinned ? 'üìå √âpingl√©' : 'üìå √âpingler'; });

function selectRow(tr, openDrawerIfClosed){
  rows.forEach(r => r.classList.toggle('selected', r===tr));
  renderDetails(tr);
  if(openDrawerIfClosed){ openDrawer(); }
}
function renderDetails(r){
  dTitle.textContent = `${r.dataset.symbol} ¬∑ ${r.dataset.venue}`;
  const tvl = r.dataset.tvl ? money(+r.dataset.tvl) : 'N/D';
  const mctvl = r.dataset.mctvl ? fmtNum2(+r.dataset.mctvl) : '‚Äî';
  dMarket.innerHTML = `
    <div class="k">Date</div><div class="num">${r.dataset.alert||'‚Äî'}</div>
    <div class="k">Prix</div><div class="num">${r.dataset.price||'‚Äî'}</div>
    <div class="k">Market Cap</div><div class="num">${r.dataset.mc||'‚Äî'}</div>
    <div class="k">TVL</div><div class="num">${tvl}</div>
    <div class="k">MC/TVL</div><div class="num">${mctvl}</div>
    <div class="k">ATH (prix)</div><div class="num">${r.dataset.ath||'‚Äî'}</div>
    <div class="k">ATH Mcap</div><div class="num">${r.dataset.athmc||'‚Äî'}</div>
    <div class="k">x ATH Mcap</div><div class="num">${r.dataset.xathmc? 'x'+nf1.format(+r.dataset.xathmc):'‚Äî'}</div>
    <div class="k">Prix cible (ATH Mcap)</div><div class="num">${r.dataset.pricetarget||'‚Äî'}</div>
    <div class="k">Vol/MC (24h)</div><div class="num">${(isNaN(parseFloat(r.dataset.volmc))?'‚Äî':(nf2.format(parseFloat(r.dataset.volmc))+'%'))}</div>
    <div class="k">Moy Vol7j/TVL</div><div class="num">${(isNaN(parseFloat(r.dataset.vol7tvl))?'‚Äî':(nf2.format(parseFloat(r.dataset.vol7tvl))+'%'))}</div>
    <div class="k">Var Vol 7j/30j</div><div class="num">${r.dataset.varv? nf2.format(+r.dataset.varv)+'√ó':'‚Äî'}</div>
    <div class="k">RSI Daily (14)</div><div class="num">${r.dataset.rsid? nf2.format(+r.dataset.rsid):'‚Äî'}</div>
    <div class="k">RSI H4 (14)</div><div class="num">${r.dataset.rsih4? nf2.format(+r.dataset.rsih4):'‚Äî'}</div>
    <div class="k">Source TVL</div><div class="num">${r.dataset.tvlsrc||'‚Äî'}</div>`;
  const t = {
    tvl: (r.dataset.tvl? +r.dataset.tvl : null),
    mc_tvl: (r.dataset.mctvl? +r.dataset.mctvl : null),
    var_vol_7_over_30: (r.dataset.varv? +r.dataset.varv : null),
    vol_mc_24: (r.dataset.volmc? +r.dataset.volmc : null),
    x_ath_mc: (r.dataset.xathmc? +r.dataset.xathmc : null),
    rsi_d: (r.dataset.rsid? +r.dataset.rsid : null)
  };
  dSignals.innerHTML = badgesHTML(buildSignals(t));
}

/* Cartes */
const cardsToggle = document.getElementById('cardsToggle');
const cardsWrap = document.getElementById('cardsWrap');
const cardsGrid = document.getElementById('cardsGrid');

function renderCards(list){
  if(!cardsToggle.checked){ cardsWrap.classList.remove('show'); return; }
  cardsWrap.classList.add('show');
  cardsGrid.innerHTML = '';
  list.forEach(t=>{
    const sigs = buildSignals(t);
    const head = `
      <div class="sig-head">
        <div>
          <div class="sig-title">${t.symbol}</div>
          <div class="sig-sub">${t.alert_date || '‚Äî'} ¬∑ ${t.venue||''}</div>
        </div>
        <div class="sig-price">${t.price!=null ? '$'+nf2.format(+t.price) : '‚Äî'}</div>
      </div>`;

    const sub = `<div class="sig-sub">MC ${money(t.mc)} ¬∑ TVL ${t.tvl!=null?money(t.tvl):'N/D'}</div>`;

    const chips = `
      <div class="sig-metrics">
        <span class="chip">MC/TVL ${t.mc_tvl!=null?fmtNum2(t.mc_tvl):'‚Äî'}</span>
        <span class="chip">RSI D ${t.rsi_d!=null?nf2.format(+t.rsi_d):'‚Äî'}</span>
        <span class="chip">x ATH Mcap ${t.x_ath_mc!=null?('x'+nf1.format(+t.x_ath_mc)):'‚Äî'}</span>
        <span class="chip">Vol/MC 24h ${t.vol_mc_24!=null?fmtPct(t.vol_mc_24):'‚Äî'}</span>
      </div>`;

    const badges = badgesHTML(sigs);

    // Explications pliables
    const explain = sigs.map(s=>`<li><span class="badge ${s.c}" style="margin-right:8px">${s.k}</span>${(SIGNAL_EXPLAIN[s.key]||'')}</li>`).join('') || '<li>Aucun signal sp√©cifique.</li>';

    const div = document.createElement('div');
    div.className = 'sig-card';
    const symId = `exp-${t.symbol}`;
    div.innerHTML = `
      ${head}
      <div class="sig-section">${sub}${chips}</div>
      <div class="sig-section">${badges}</div>
      <hr class="sig-divider">
      <div class="sig-actions">
        <div class="linkbar">
          ${t.website?`<a href="${t.website}" target="_blank">Site</a>`:''}
          ${t.whitepaper?`<a href="${t.whitepaper}" target="_blank">WP</a>`:''}
          ${t.twitter?`<a href="${t.twitter}" target="_blank">Twitter</a>`:''}
          ${t.github?`<a href="${t.github}" target="_blank">GitHub</a>`:''}
        </div>
        <div>
          <button class="btn-ghost" data-sym="${t.symbol}" data-open="drawer">D√©tails</button>
          <button class="btn-ghost" data-target="#${symId}" data-toggle="exp">+ D‚Äôinfos</button>
        </div>
      </div>
      <div id="${symId}" style="display:none;">
        <ul class="sig-sub" style="margin:10px 0 0 0; padding-left:18px;">${explain}</ul>
        <div class="sig-sub" style="margin-top:8px;">Source TVL: ${t.tvl_source || '‚Äî'}</div>
      </div>
    `;
    // actions
    div.querySelector('[data-open="drawer"]').addEventListener('click', ()=>{
      const tr = Array.from(rows).find(r => r.dataset.symbol === t.symbol);
      if(tr){ selectRow(tr, true); window.scrollTo({ top:0, behavior:'smooth' }); }
    });
    div.querySelector('[data-toggle="exp"]').addEventListener('click', (ev)=>{
      const tgt = div.querySelector(ev.currentTarget.getAttribute('data-target'));
      const open = tgt.style.display !== 'none';
      tgt.style.display = open ? 'none' : 'block';
      ev.currentTarget.textContent = open ? '+ D‚Äôinfos' : '‚àí Masquer';
    });
    cardsGrid.appendChild(div);
  });
}
cardsToggle.addEventListener('change', ()=> renderCards(tokensData));

/* Drawer resize */
const resizer = document.getElementById('drawerResizer');
let drag=false, startX=0, startW=0;
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function setDrawerWidth(px){
  const min = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--drawer-min'))||300;
  const max = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--drawer-max'))||640;
  const w = Math.max(min, Math.min(max, Math.min(px, window.innerWidth-240)));
  document.documentElement.style.setProperty('--drawer-w', w+'px');
  localStorage.setItem('drawerW', String(w));
}
resizer.addEventListener('mousedown', (e)=>{
  if(window.matchMedia('(max-width:980px)').matches) return;
  e.preventDefault(); drag=true; document.body.classList.add('resizing');
  startX=e.clientX; startW=drawer.getBoundingClientRect().width;
  window.addEventListener('mousemove', onDrag);
  window.addEventListener('mouseup', onStopDrag);
});
function onDrag(e){ if(!drag) return; const dx = startX - e.clientX; setDrawerWidth(startW + dx); }
function onStopDrag(){ if(!drag) return; drag=false; document.body.classList.remove('resizing');
  window.removeEventListener('mousemove', onDrag); window.removeEventListener('mouseup', onStopDrag); }
const savedW = parseInt(localStorage.getItem('drawerW'),10);
if(!isNaN(savedW)) document.documentElement.style.setProperty('--drawer-w', savedW+'px');

/* Search & Refresh */
document.getElementById('search').addEventListener('input', (e)=>{
  const q = e.target.value.trim().toLowerCase();
  rows.forEach(r=>{ r.style.display = r.innerText.toLowerCase().includes(q)? '' : 'none'; });
});
document.getElementById('btnRefresh').addEventListener('click', loadData);
const autoToggle = document.getElementById('autoToggle');
let autoTimer=null;
function startAuto(){ stopAuto(); autoTimer=setInterval(loadData, 60_000); }
function stopAuto(){ if(autoTimer){ clearInterval(autoTimer); autoTimer=null; } }
autoToggle.checked = localStorage.getItem('autoRefresh')==='1';
if(autoToggle.checked) startAuto();
autoToggle.addEventListener('change', ()=>{ if(autoToggle.checked){ startAuto(); localStorage.setItem('autoRefresh','1'); } else { stopAuto(); localStorage.setItem('autoRefresh','0'); } });

/* Init */
loadData();
</script>
</body>
</html>
