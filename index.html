<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scan MA50 v1.2 — Screener (CMC + Llama)</title>
<style>
  :root{
    --bg:#0b1016;--panel:#0f1422;--panel-2:#121a2b;--text:#e9eef5;--muted:#9aa7b8;
    --green:#28d39b;--red:#ff6b6b;--amber:#ffc857;--blue:#8bb7ff;--outline:#1c2742;
    --radius:14px; --gap:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0f19,#0b1016);color:var(--text);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:6px}
  .title{font-weight:800;font-size:22px;letter-spacing:.2px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .toolbar input,.btn{background:var(--panel-2);color:var(--text);border:1px solid var(--outline);border-radius:12px;padding:8px 12px}
  .btn{cursor:pointer}
  .note{color:var(--muted);font-size:12px;margin:8px 0 16px}
  #debug{display:none;margin:10px 0;padding:10px;border:1px dashed #ff6b6b;color:#ffb3b3;background:#381e1e;border-radius:12px;white-space:pre-wrap}
  #debug.show{display:block}

  .card{background:var(--panel);border:1px solid var(--outline);border-radius:var(--radius);overflow:hidden}
  .table-scroller{width:100%;overflow:auto}
  table{width:100%;border-collapse:separate;border-spacing:0; min-width:920px;}
  thead th{position:sticky;top:0;background:linear-gradient(180deg,var(--panel),var(--panel-2));
    color:#cfe0ff;text-align:left;font-weight:700;font-size:12px;text-transform:uppercase;
    letter-spacing:.5px;border-bottom:1px solid var(--outline);padding:10px 12px}
  tbody td{padding:10px 12px;border-bottom:1px solid #0e1525; vertical-align:middle;}
  tbody tr:hover{background:rgba(255,255,255,.03)}
  .token{display:flex;align-items:center;gap:10px}
  .logo{width:22px;height:22px;border-radius:7px;background:linear-gradient(135deg,#1f2846,#2a3f6f)}
  .sym{font-weight:800}
  .muted{color:var(--muted)}
  .num{font-variant-numeric:tabular-nums; white-space:nowrap;}
  .t-good{color:var(--green)} .t-warn{color:var(--amber)} .t-bad{color:var(--red)}
  @media (max-width: 1100px){ .col-optional{ display:none; } }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">Scan MA50 v1.2 — Screener</div>
    <div class="toolbar">
      <input id="search" placeholder="Rechercher un token…" />
      <button id="btnRefresh" class="btn">↻ Rafraîchir</button>
      <label><input type="checkbox" id="autoToggle"> Auto-refresh (60s)</label>
    </div>
  </header>
  <div class="note" id="lastupdate">Chargement…</div>
  <div id="debug"></div>

  <div class="card"><div class="table-scroller">
    <table id="screener">
      <thead><tr>
        <th>Token</th>
        <th>Date</th>
        <th>Prix</th>
        <th>Δ24h</th>
        <th class="col-optional">Δ7j</th>
        <th class="col-optional">Δ30j</th>
        <th>Market Cap</th>
        <th>TVL</th>
        <th>MC/TVL</th>
        <th class="col-optional">Vol/MC (24h)</th>
        <th class="col-optional">FDV</th>
        <th class="col-optional">Rank</th>
      </tr></thead>
      <tbody></tbody>
    </table>
    <div class="note" id="emptyMsg" style="display:none;padding:10px;">Aucune ligne</div>
  </div></div>
</div>

<script>
/* ===== Helpers de format ===== */
const debugBox = document.getElementById('debug');
function debug(msg){ try{ debugBox.classList.add('show'); debugBox.textContent += (debugBox.textContent? '\\n':'') + msg; console.error(msg);}catch(_){} }
window.addEventListener('error', e=> debug('JS Error: '+(e.error?.message||e.message)));
window.addEventListener('unhandledrejection', e=> debug('Promise Rejection: '+(e.reason?.message||e.reason)));

const nf2 = new Intl.NumberFormat('en-US',{ maximumFractionDigits: 2 });
const nf1 = new Intl.NumberFormat('en-US',{ maximumFractionDigits: 1 });
const money = n => (n==null||isNaN(n)) ? 'N/D' : '$' + (
  Math.abs(n)>=1e12? nf2.format(n/1e12)+'T' :
  Math.abs(n)>=1e9 ? nf2.format(n/1e9)+'B' :
  Math.abs(n)>=1e6 ? nf2.format(n/1e6)+'M' :
  Math.abs(n)>=1e3 ? nf2.format(n/1e3)+'K' : nf2.format(n)
);
const fmtPct0 = n => (n==null||isNaN(n)) ? '—' : `${Math.round(+n)}%`;

/* ===== DOM refs ===== */
const tbody = document.querySelector('#screener tbody');
const emptyMsg = document.getElementById('emptyMsg');
const lastupdate = document.getElementById('lastupdate');
const searchInput = document.getElementById('search');
const btnRefresh = document.getElementById('btnRefresh');
const autoToggle = document.getElementById('autoToggle');

let allRows = [];
let masterData = [];
let autoTimer=null;

/* ===== Rendu ===== */
function render(data){
  masterData = Array.isArray(data?.tokens) ? data.tokens : [];
  lastupdate.textContent = 'Dernière MàJ : ' + (data.updated_at || '—');

  tbody.innerHTML=''; allRows.length=0;
  if(!masterData.length){ emptyMsg.style.display='block'; return; }
  emptyMsg.style.display='none';

  masterData.forEach(t=>{
    const tr = document.createElement('tr');

    const price = (t.price!=null) ? '$'+nf2.format(+t.price) : '—';
    const d24 = fmtPct0(t.d24);
    const d7  = fmtPct0(t.d7);
    const d30 = fmtPct0(t.d30);
    const mc  = money(t.mc);
    const tvl = (t.tvl!=null) ? money(t.tvl) : 'N/D';
    const mctvl = (t.mc!=null && t.tvl!=null && t.tvl>0) ? nf2.format(t.mc/t.tvl) : '—';
    const volmc = (t.vol_mc_24!=null) ? nf2.format(+t.vol_mc_24)+'%' : '—';
    const fdv = (t.fdv!=null) ? money(t.fdv) : '—';
    const rank = (t.rank!=null) ? String(t.rank) : '—';

    tr.innerHTML = `
      <td><div class="token"><div class="logo"></div><div><span class="sym">${t.symbol||''}</span><span class="muted"> · ${t.venue||''}</span></div></div></td>
      <td class="num">${t.alert_date || '—'}</td>
      <td class="num">${price}</td>
      <td class="num">${d24}</td>
      <td class="num col-optional">${d7}</td>
      <td class="num col-optional">${d30}</td>
      <td class="num">${mc}</td>
      <td class="num">${tvl}</td>
      <td class="num">${mctvl}</td>
      <td class="num col-optional">${volmc}</td>
      <td class="num col-optional">${fdv}</td>
      <td class="num col-optional">${rank}</td>
    `;

    // color rules
    const mctvlCell = tr.children[8];
    const mctvlVal = parseFloat((t.mc!=null && t.tvl!=null && t.tvl>0) ? (t.mc/t.tvl) : NaN);
    if(!isNaN(mctvlVal)){
      if(mctvlVal <= 3) mctvlCell.classList.add('t-good');
      else if(mctvlVal <= 8) mctvlCell.classList.add('t-warn');
      else mctvlCell.classList.add('t-bad');
    }
    const volCell = tr.children[9];
    const volVal = parseFloat(t.vol_mc_24);
    if(!isNaN(volVal)){
      if(volVal >= 5) volCell.classList.add('t-good');
      else if(volVal >= 2) volCell.classList.add('t-warn');
      else volCell.classList.add('t-bad');
    }

    tbody.appendChild(tr);
    allRows.push(tr);
  });
}

/* ===== Chargement ===== */
async function loadData(){
  try{
    // IMPORTANT: data.json au même niveau que index.html
    const res = await fetch('data.json?ts='+Date.now(), { cache:'no-store' });
    if(!res.ok){
      debug(`HTTP ${res.status} ${res.statusText} sur data.json`);
      lastupdate.textContent = 'Erreur: data.json introuvable';
      render({ tokens: [] });
      return;
    }
    const json = await res.json();
    if(!json || !Array.isArray(json.tokens)){
      debug('Format data.json inattendu (pas de tokens[])');
      render({ tokens: [] });
      lastupdate.textContent = 'Erreur: format data.json';
      return;
    }
    render(json);
  }catch(e){
    debug('loadData() failed: '+(e.message||e));
    lastupdate.textContent = 'Erreur de chargement';
    render({ tokens: [] });
  }
}

/* ===== Recherche ===== */
document.getElementById('search').addEventListener('input', (e)=>{
  const q = e.target.value.trim().toLowerCase();
  allRows.forEach(r=>{
    r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none';
  });
});

/* ===== Refresh ===== */
document.getElementById('btnRefresh').addEventListener('click', loadData);
const autoToggleEl = document.getElementById('autoToggle');
function startAuto(){ stopAuto(); autoTimer=setInterval(loadData, 60_000); }
function stopAuto(){ if(autoTimer){ clearInterval(autoTimer); autoTimer=null; } }
autoToggleEl.checked = localStorage.getItem('autoRefresh')==='1';
if(autoToggleEl.checked) startAuto();
autoToggleEl.addEventListener('change', ()=>{
  if(autoToggleEl.checked){ startAuto(); localStorage.setItem('autoRefresh','1'); }
  else { stopAuto(); localStorage.setItem('autoRefresh','0'); }
});

/* ===== Boot ===== */
document.addEventListener('DOMContentLoaded', loadData);
</script>
</body>
</html>
