<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Screener â€” Scan MA50 v1.2 (data.json + popover)</title>
<style>
  :root{
    --bg:#0b0d12;--panel:#0f1320;--panel-2:#121727;--text:#e6edf3;--muted:#9aa4b2;--green:#29d397;--red:#ff6b6b;--amber:#ffc857;--blue:#6aa7ff;--card:#0c111b;--outline:#1e2a44;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0d16,#0b0d12);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
  header{display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:16px}
  .title{font-weight:700;font-size:22px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap}
  .toolbar input,.toolbar select{background:var(--panel-2);color:var(--text);border:1px solid var(--outline);border-radius:10px;padding:8px 10px}
  .note{color:var(--muted);font-size:12px;margin-top:4px}

  .table-wrap{background:var(--panel);border:1px solid var(--outline);border-radius:14px;overflow:hidden;box-shadow:0 10px 24px rgba(0,0,0,.35)}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:linear-gradient(180deg,var(--panel),var(--panel-2));color:#cfe0ff;text-align:left;font-weight:600;font-size:12px;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--outline);padding:12px 10px;cursor:pointer;user-select:none}
  tbody td{padding:12px 10px;border-bottom:1px solid #0f1422}
  tbody tr:hover{background:rgba(255,255,255,.03)}
  .token{display:flex;align-items:center;gap:10px}
  .logo{width:20px;height:20px;border-radius:6px;background:linear-gradient(135deg,#1e2440,#2c3f6b)}
  .sym{font-weight:700}
  .muted{color:var(--muted)}
  .num{font-variant-numeric:tabular-nums}
  .pos{color:var(--green)}
  .neg{color:var(--red)}
  .t-good{color:var(--green)} .t-warn{color:var(--amber)} .t-bad{color:var(--red)}

  /* Global popover */
  #popover{position:fixed;left:0;top:0;transform:translate(-9999px,-9999px);min-width:540px;max-width:620px;border:1px solid var(--outline);background:var(--card);border-radius:14px;box-shadow:0 20px 40px rgba(0,0,0,.55);padding:14px;z-index:1000;display:none}
  #popover .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  #popover .title{font-size:16px}
  #popover .lock{font-size:12px;color:var(--muted);cursor:pointer;border:1px solid var(--outline);border-radius:8px;padding:4px 8px;background:var(--panel-2)}
  #popover.locked .lock{color:#fff;border-color:#29d397;box-shadow:inset 0 0 0 1px #29d397}
  #popover .grid{display:grid;grid-template-columns:1.1fr 1fr;gap:12px}
  #popover h4{margin:0 0 8px 0;font-size:14px}
  #popover .kv{display:grid;grid-template-columns:1fr auto;gap:6px;font-size:13px}
  #popover .sep{height:1px;background:var(--outline);margin:8px 0}
  #popover .links{display:flex;gap:10px;flex-wrap:wrap}
  #popover .links a{color:#9ec5ff;text-decoration:none}

  @media (max-width: 820px){
    #popover{left:12px !important;right:12px;top:auto;bottom:12px;min-width:unset;max-width:unset;transform:none}
    thead .hide-sm, tbody .hide-sm{display:none}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">Scan MA50 v1.2 â€” Screener (via data.json)</div>
      <div class="toolbar">
        <input id="search" placeholder="Rechercher un tokenâ€¦" />
      </div>
    </header>
    <div class="note" id="lastupdate">Chargementâ€¦</div>

    <div class="table-wrap">
      <table id="screener">
        <thead>
          <tr>
            <th data-sort="token">Token</th>
            <th data-sort="price">Prix</th>
            <th data-sort="d24">Î”24h</th>
            <th data-sort="d7">Î”7j</th>
            <th class="hide-sm" data-sort="d30">Î”30j</th>
            <th data-sort="mc">MC</th>
            <th data-sort="tvl">TVL</th>
            <th data-sort="mctvl">MC/TVL</th>
            <th class="hide-sm" data-sort="volmc">Vol/MC (24h)</th>
            <th class="hide-sm" data-sort="vol7mc">Moy Vol7j/MC</th>
            <th data-sort="varvol">Var Vol 7j/30j</th>
            <th data-sort="rsid">RSI D</th>
            <th class="hide-sm" data-sort="rsih4">RSI H4</th>
            <th class="hide-sm" data-sort="ath">ATH</th>
            <th data-sort="pot">Potentiel x</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Global Popover -->
  <div id="popover" aria-hidden="true">
    <div class="hdr">
      <div class="title" id="p-title"></div>
      <button id="p-lock" class="lock" title="Verrouiller / dÃ©verrouiller">ğŸ”’ Verrouiller</button>
    </div>
    <div class="grid">
      <div>
        <h4>ğŸ“Š MarchÃ©</h4>
        <div class="kv" id="p-market"></div>
        <div class="sep"></div>
        <h4>âš™ï¸ Techniques</h4>
        <div class="kv" id="p-tech"></div>
      </div>
      <div>
        <h4>ğŸ§© Fonda</h4>
        <div class="kv" id="p-fonda"></div>
        <div class="sep"></div>
        <h4>ğŸ›¡ï¸ SÃ©curitÃ© & Tokenomics</h4>
        <div class="kv" id="p-sec"></div>
        <div class="sep"></div>
        <div class="links" id="p-links"></div>
      </div>
    </div>
  </div>

<script>
// ===== Helpers =====
const fmtNum = n => (n===null||n===undefined||isNaN(n)) ? 'N/D' : new Intl.NumberFormat('en-US',{maximumFractionDigits:2}).format(n);
const fmtAbbrev = (n, prefix='') => {
  if(n===null||n===undefined||isNaN(n)) return 'N/D';
  const abs=Math.abs(n);
  if(abs>=1e12) return prefix+(n/1e12).toFixed(2)+'T';
  if(abs>=1e9) return prefix+(n/1e9).toFixed(2)+'B';
  if(abs>=1e6) return prefix+(n/1e6).toFixed(2)+'M';
  if(abs>=1e3) return prefix+(n/1e3).toFixed(2)+'K';
  return prefix+n.toFixed(2);
};
const pct = n => (n===null||n===undefined||isNaN(n)) ? 'â€”' : (n>=0?'+':'')+Number(n).toFixed(0)+'%';
const mult = n => (n===null||n===undefined||isNaN(n)) ? 'â€”' : 'x'+Number(n).toFixed(1);
const money = n => (n===null||n===undefined||isNaN(n)) ? 'N/D' : '$'+fmtAbbrev(n);

// ===== Build table from data.json =====
const tbody = document.querySelector('#screener tbody');
const rows = [];
let tokensData = [];

async function loadData(){
  try{
    const res = await fetch('data.json', {cache:'no-store'});
    const json = await res.json();
    tokensData = json.tokens||[];
    document.getElementById('lastupdate').textContent = 'DerniÃ¨re MÃ J : '+(json.updated_at||'â€”');
    tbody.innerHTML='';
    tokensData.forEach(t=> addRow(t));
    attachRowHandlers();
    applyThresholds();
  }catch(e){
    document.getElementById('lastupdate').textContent = 'Erreur de chargement de data.json';
  }
}

function addRow(t){
  const tr=document.createElement('tr');
  tr.dataset.token = `${t.symbol||''} Â· ${t.venue||''}`;
  tr.dataset.price = t.price; tr.dataset.mc = money(t.mc); tr.dataset.fdv = t.fdv?money(t.fdv):'â€”';
  tr.dataset.ath = (t.ath?('$'+t.ath):'â€”'); tr.dataset.pot = mult(t.ath_mult);
  tr.dataset.volmc = (t.vol_mc_24!==undefined? t.vol_mc_24+'%':'â€”');
  tr.dataset.vol7mc = (t.vol7_mc!==undefined? t.vol7_mc+'%':'â€”');
  tr.dataset.rsid = t.rsi_d; tr.dataset.rsih4 = t.rsi_h4;
  tr.dataset.narr = t.narrative||'â€”'; tr.dataset.launch = t.launch_date||'â€”';
  tr.dataset.comp = (t.competitors||[]).join(', ')||'â€”'; tr.dataset.audits = (t.audits||[]).join(', ')||'â€”';
  tr.dataset.unlock = t.next_unlock||'â€”';
  tr.dataset.tvl = (t.tvl!==null&&t.tvl!==undefined)? money(t.tvl):'N/D';
  tr.dataset.mctvl = (t.mc_tvl!==null&&t.mc_tvl!==undefined)? t.mc_tvl: '';

  tr.innerHTML = `
    <td><div class="token"><div class="logo"></div><div><span class="sym">${t.symbol||''}</span><span class="muted"> Â· ${t.venue||''}</span></div></div></td>
    <td class="num">$${(t.price!==undefined?Number(t.price).toFixed(4):'â€”')}</td>
    <td class="num">${pct(t.d24)}</td>
    <td class="num">${pct(t.d7)}</td>
    <td class="num hide-sm">${pct(t.d30)}</td>
    <td class="num">${money(t.mc)}</td>
    <td class="num">${(t.tvl!==null&&t.tvl!==undefined)? money(t.tvl):'N/D'}</td>
    <td class="num">${(t.mc_tvl!==null&&t.mc_tvl!==undefined)? t.mc_tvl : 'â€”'}</td>
    <td class="num hide-sm">${(t.vol_mc_24!==undefined? t.vol_mc_24+'%':'â€”')}</td>
    <td class="num hide-sm">${(t.vol7_mc!==undefined? t.vol7_mc+'%':'â€”')}</td>
    <td class="num">${(t.var_vol_7_over_30!==undefined? Number(t.var_vol_7_over_30).toFixed(2)+'Ã—':'â€”')}</td>
    <td class="num">${(t.rsi_d!==undefined? t.rsi_d:'â€”')}</td>
    <td class="num hide-sm">${(t.rsi_h4!==undefined? t.rsi_h4:'â€”')}</td>
    <td class="num hide-sm">${(t.ath!==undefined? '$'+t.ath:'â€”')}</td>
    <td class="num">${(t.ath_mult!==undefined? 'x'+t.ath_mult:'â€”')}</td>`;
  tbody.appendChild(tr);
  rows.push(tr);
}

// ===== Search =====
const search = document.getElementById('search');
search.addEventListener('input', ()=>{
  const q = search.value.trim().toLowerCase();
  rows.forEach(r=>{ r.style.display = r.innerText.toLowerCase().includes(q)? '' : 'none'; });
});

// ===== Sort (toggle asc/desc) =====
const headers = Array.from(document.querySelectorAll('thead th'));
let sortState = {idx:null, dir:1};
headers.forEach((th, idx)=> th.addEventListener('click', ()=>{
  const tbodyEl = th.closest('table').querySelector('tbody');
  const getVal=(tr)=> tr.children[idx].innerText.replace(/[,$%xÃ—\s]/g,'');
  const numeric = rows.every(r=> !isNaN(parseFloat(getVal(r))) );
  const dir = (sortState.idx===idx? -sortState.dir : 1);
  sortState={idx,dir};
  const sorted = Array.from(tbodyEl.querySelectorAll('tr')).sort((a,b)=>{
    const va=getVal(a), vb=getVal(b);
    if(numeric){ return (parseFloat(va)||-Infinity) - (parseFloat(vb)||-Infinity); }
    return va.localeCompare(vb);
  });
  if(dir<0) sorted.reverse();
  sorted.forEach(tr=>tbodyEl.appendChild(tr));
}));

// ===== Threshold coloring (MC/TVL, Vol/MC 24h, RSI D) =====
function applyThresholds(){
  rows.forEach(r=>{
    const mctvl = parseFloat((r.dataset.mctvl||'').toString());
    const volmc = parseFloat((r.dataset.volmc||'').toString());
    const rsid = parseFloat((r.dataset.rsid||'').toString());
    // MC/TVL cell index 7
    const mctvlCell = r.children[7];
    if(mctvlCell){
      if(!isNaN(mctvl)){
        if(mctvl <= 3) mctvlCell.classList.add('t-good');
        else if(mctvl <= 8) mctvlCell.classList.add('t-warn');
        else mctvlCell.classList.add('t-bad');
      } else {
        mctvlCell.classList.add('t-warn');
      }
    }
    // Vol/MC 24h cell index 8
    const volCell = r.children[8];
    if(volCell){
      if(!isNaN(volmc)){
        if(volmc >= 5) volCell.classList.add('t-good');
        else if(volmc >= 2) volCell.classList.add('t-warn');
        else volCell.classList.add('t-bad');
      }
    }
    // RSI D cell index 11
    const rsiCell = r.children[11];
    if(rsiCell && !isNaN(rsid)){
      if(rsid >= 70) rsiCell.classList.add('t-bad');
      else if(rsid >= 45 && rsid <= 60) rsiCell.classList.add('t-good');
      else rsiCell.classList.add('t-warn');
    }
  });
}

// ===== Popover global (delay + lock + smart position) =====
const pop = document.getElementById('popover');
const pTitle = document.getElementById('p-title');
const pMarket = document.getElementById('p-market');
const pTech = document.getElementById('p-tech');
const pFonda = document.getElementById('p-fonda');
const pSec = document.getElementById('p-sec');
const pLinks = document.getElementById('p-links');
const pLockBtn = document.getElementById('p-lock');
let showTimer=null, locked=false;

function fillPop(r){
  pTitle.textContent = r.dataset.token || '';
  pMarket.innerHTML = `
    <div>Prix</div><div class="num">${r.dataset.price||'â€”'}</div>
    <div>MC</div><div class="num">${r.dataset.mc||'â€”'}</div>
    ${r.dataset.tvl?`<div>TVL</div><div class="num">${r.dataset.tvl}</div>`:''}
    ${r.dataset.mctvl?`<div>MC/TVL</div><div class="num">${r.dataset.mctvl}</div>`:''}
    <div>ATH</div><div class="num">${r.dataset.ath||'â€”'}</div>
    <div>Potentiel x</div><div class="num">${r.dataset.pot||'â€”'}</div>
    <div>Vol/MC (24h)</div><div class="num">${r.dataset.volmc||'â€”'}</div>
    <div>Moy Vol7j/MC</div><div class="num">${r.dataset.vol7mc||'â€”'}</div>`;
  pTech.innerHTML = `
    <div>RSI Daily / H4</div><div class="num">${r.dataset.rsid||'â€”'} / ${r.dataset.rsih4||'â€”'}</div>
    <div>MA50</div><div class="num">â€”</div>`;
  pFonda.innerHTML = `
    <div>Narratif</div><div>${r.dataset.narr||'â€”'}</div>
    <div>Date de lancement</div><div>${r.dataset.launch||'â€”'}</div>
    <div>CompÃ©titeurs</div><div>${r.dataset.comp||'â€”'}</div>`;
  pSec.innerHTML = `
    <div>Audits</div><div>${r.dataset.audits||'â€”'}</div>
    <div>Unlock proche</div><div>${r.dataset.unlock||'â€”'}</div>
    <div>FDV</div><div class="num">${r.dataset.fdv||'â€”'}</div>`;
  // Liens (optionnels)
  pLinks.innerHTML='';
}

function positionPop(x,y){
  const pad=16; const rect=pop.getBoundingClientRect();
  let left=x+pad, top=y+pad;
  if(left+rect.width>window.innerWidth-8) left = x - rect.width - pad;
  if(top+rect.height>window.innerHeight-8) top = y - rect.height - pad;
  pop.style.left=left+'px'; pop.style.top=top+'px';
}

function attachRowHandlers(){
  const allRows = Array.from(document.querySelectorAll('#screener tbody tr'));
  allRows.forEach(r=>{
    r.addEventListener('mouseenter', (e)=>{
      if(locked) return; if(showTimer) clearTimeout(showTimer);
      showTimer=setTimeout(()=>{
        fillPop(r);
        pop.style.display='block'; pop.style.transform='none'; pop.removeAttribute('aria-hidden');
        positionPop(e.clientX, e.clientY);
      }, 200);
    });
    r.addEventListener('mousemove', (e)=>{ if(pop.style.display==='block' && !locked) positionPop(e.clientX,e.clientY); });
    r.addEventListener('mouseleave', ()=>{ if(!locked){ if(showTimer) clearTimeout(showTimer); hidePop(); } });
    r.addEventListener('click', ()=>{ // toggle lock on row click
      locked=!locked; pop.classList.toggle('locked', locked);
      pLockBtn.textContent = locked ? 'ğŸ”“ DÃ©verrouiller' : 'ğŸ”’ Verrouiller';
      if(!locked) hidePop();
    });
  });
}

function hidePop(){ if(locked) return; pop.style.display='none'; pop.style.transform='translate(-9999px,-9999px)'; pop.setAttribute('aria-hidden','true'); }

pLockBtn.addEventListener('click', (e)=>{ e.stopPropagation(); locked=!locked; pop.classList.toggle('locked', locked); pLockBtn.textContent=locked?'ğŸ”“ DÃ©verrouiller':'ğŸ”’ Verrouiller'; if(!locked) hidePop(); });

document.addEventListener('click', (e)=>{ if(locked && !pop.contains(e.target)){ locked=false; pop.classList.remove('locked'); pLockBtn.textContent='ğŸ”’ Verrouiller'; hidePop(); } });

loadData();
</script>
</body>
</html>
